#!/bin/bash

#
# Install npm packages using the alterate versions of node and npm
# that were installed by the pre_build hook.
#
# Also attempt to create the MySQL database if it does not exist
#
# This hook runs after pre_build, but before deploy. It is responsible
# for getting the appliation into a runnable state.
#
# Note that OpenShift environment variables have a trailing slash.
#

echo "Starting build hook"

START=$(date +'%s')

cd $OPENSHIFT_REPO_DIR

if [[ -f "package.json.bak" ]]; then
    mv package.json.bak package.json
fi

npm install

# Bower wants to write to $HOME/config, but that's not writeable
# Temporarily change the value of $HOME
BOWER_TMP_HOME="$HOME/.node_modules/bower"
mkdir -p "$BOWER_TMP_HOME"

ORIGINAL_HOME="$HOME"
HOME="$BOWER_TMP_HOME"
bower install
HOME="$ORIGINAL_HOME"


# Database creation
DB_EXISTS=$(mysql -B -e 'show databases' | grep -c notifier)

if [ $DB_EXISTS == 0 ]; then
    echo -n "MySQL database does not exist, creating..."
    mysqladmin -h$OPENSHIFT_MYSQL_DB_HOST -u$OPENSHIFT_MYSQL_DB_USERNAME -p$OPENSHIFT_MYSQL_DB_PASSWORD create notifier
    echo "done"
else
    echo "The MySQL database exists, will not attempt to create."
fi

DURATION=$(($(date +'%s') - START))

echo "Finished build hook in $DURATION seconds"
